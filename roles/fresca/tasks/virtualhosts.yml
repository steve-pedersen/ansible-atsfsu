---
# Playbook for Apache-Fresca virtual host configuration
- include_vars: test-secrets.yml
- include_vars: prod-secrets.yml


# Copy SSL certs - file/key names set conditionally based on test or prod
- name: Create certs folder test
  file: path=/etc/apache2/certs state=directory mode=0755
  tags: certs

- name: Copy SSLCertificateFile test
  copy: 
    content: "{{ test_cert_file }}"
    dest: /etc/apache2/certs/{{ test_cert_file_filename }}
    mode: 0644
  when: test
  tags: certs

- name: Copy SSLCertificateKeyFile test
  copy: 
    content: "{{ test_cert_key }}"
    dest: /etc/apache2/certs/{{ test_cert_key_filename }}
    mode: 0600
  when: test
  tags: certs

- name: Copy SSLCertificateFile production
  copy: 
    content: "{{ prod_cert_file }}"
    dest: /etc/apache2/certs/{{ prod_cert_file_filename }}
    mode: 0644
  when: production
  tags: certs

- name: Copy SSLCertificateKeyFile production
  copy: 
    content: "{{ prod_cert_key }}"
    dest: /etc/apache2/certs/{{ prod_cert_key_filename }}
    mode: 0600
  when: production
  tags: certs


# Copy virtual host file and enable site
- name: Copy fresca.conf virtualhost file test
  template: src=fresca.vhost-test.conf.j2 dest=/etc/apache2/sites-available/fresca.conf mode=0644
  when: test

- name: Copy fresca.conf virtualhost file production
  template: src=fresca.vhost-prod.conf.j2 dest=/etc/apache2/sites-available/fresca.conf mode=0644
  when: production

- name: Enable fresca virtualhost file
  command: a2ensite fresca

- name: Check that our config is valid
  command: apache2ctl configtest
  register: result
  ignore_errors: True

- name: Rolling back - Restoring old default virtualhost
  command: a2ensite 000-default
  when: result|failed

- name: Rolling back - Removing our virtualhost
  command: a2dissite fresca
  when: result|failed

- name: Rolling back - Ending playbook
  fail: msg="Configuration file is not valid. Please check that before re-running the playbook."
  when: result|failed

- name: Deactivates the default virtualhost
  command: a2dissite 000-default

- name: Deactivates the default ssl virtualhost
  command: a2dissite default-ssl
  notify: restart apache2